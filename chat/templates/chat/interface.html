{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col h-full">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 py-3 px-6 flex justify-between items-center shadow-md z-10">
        <div class="flex items-center space-x-3">
            <div
                class="h-8 w-8 rounded-full bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center shadow-inner">
                <svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-white tracking-tight">{{ db_name }}</h2>
                <p class="text-xs text-green-400 flex items-center">
                    <span class="w-1.5 h-1.5 bg-green-400 rounded-full inline-block mr-1"></span>
                    Active Session
                </p>
            </div>
        </div>
        <div>
            <!-- Settings or specific actions could go here -->
        </div>
    </header>

    <!-- Chat Area -->
    <div class="flex-grow overflow-y-auto p-6 space-y-6 scroll-smooth" id="chat-container">
        <!-- Welcome Message -->
        <div class="flex justify-start animate-fade-in">
            <div class="flex items-end space-x-2 max-w-2xl">
                <div
                    class="w-8 h-8 rounded-full bg-primary/20 flex-shrink-0 flex items-center justify-center border border-primary/30">
                    <span class="text-primary text-xs font-bold">AI</span>
                </div>
                <div
                    class="bg-gray-800 p-4 rounded-2xl rounded-bl-none text-gray-200 shadow-md border border-gray-700/50">
                    <p>Hello! I'm connected to <span class="font-semibold text-primary">{{ db_name }}</span>. You can
                        ask me questions about your data or ask me to generate MongoDB queries.</p>
                </div>
            </div>
        </div>

        {% for msg in chat_history %}
        <div class="flex {% if msg.role == 'user' %}justify-end{% else %}justify-start{% endif %} animate-slide-up">
            {% if msg.role == 'assistant' %}
            <div class="flex items-end space-x-2 max-w-2xl">
                <div
                    class="w-8 h-8 rounded-full bg-primary/20 flex-shrink-0 flex items-center justify-center border border-primary/30">
                    <span class="text-primary text-xs font-bold">AI</span>
                </div>
                {% endif %}

                <div
                    class="p-4 rounded-2xl shadow-md {% if msg.role == 'user' %}bg-primary text-white rounded-br-none{% else %}bg-gray-800 text-gray-200 rounded-bl-none border border-gray-700/50{% endif %}">
                    <p class="whitespace-pre-wrap">{{ msg.content }}</p>
                </div>

                {% if msg.role == 'assistant' %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Input Area -->
    <div class="bg-gray-800 border-t border-gray-700 p-4 shadow-lg z-20">
        <form id="chat-form" class="max-w-4xl mx-auto relative flex items-center" method="POST">
            {% csrf_token %}
            <input type="text" name="query" id="user-input" placeholder="Ask a question about your data..."
                class="w-full bg-gray-900 text-white placeholder-gray-500 rounded-xl pl-4 pr-12 py-3 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-inner"
                autocomplete="off" required>
            <button type="submit"
                class="absolute right-2 p-2 bg-primary hover:bg-blue-600 text-white rounded-lg transition-colors shadow-md group">
                <svg class="h-5 w-5 transform group-hover:translate-x-0.5 transition-transform" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </form>
        <div class="text-center mt-2 text-xs text-gray-500">
            Powered by Groq & ChromaDB
        </div>
    </div>
</div>

{% block scripts %}
<script>
    const chatContainer = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    // Auto scroll to bottom
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    scrollToBottom();

    function appendMessage(role, content) {
        const isUser = role === 'user';
        const wrapper = document.createElement('div');
        wrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in`;

        const bubble = document.createElement('div');
        bubble.className = `max-w-[80%] rounded-2xl px-4 py-3 text-sm shadow-md ${isUser ? 'bg-primary text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-bl-none'}`;

        const roleLabel = document.createElement('p');
        roleLabel.className = `text-xs mb-1 font-semibold ${isUser ? 'text-primary-foreground/80' : 'text-gray-400'}`;
        roleLabel.innerText = isUser ? 'You' : 'Assistant';

        const messageContent = document.createElement('div');
        messageContent.className = 'whitespace-pre-wrap leading-relaxed';
        messageContent.innerText = content; // Using innerText for safety against HTML injection from raw text

        bubble.appendChild(roleLabel);
        bubble.appendChild(messageContent);
        wrapper.appendChild(bubble);
        chatContainer.appendChild(wrapper);
        scrollToBottom();
    }

    function showTyping() {
        const wrapper = document.createElement('div');
        wrapper.id = 'typing-indicator';
        wrapper.className = 'flex justify-start animate-fade-in';
        wrapper.innerHTML = `
            <div class="bg-gray-700 rounded-2xl rounded-bl-none px-4 py-3 shadow-md flex space-x-1 items-center">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
        `;
        chatContainer.appendChild(wrapper);
        scrollToBottom();
    }

    function removeTyping() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    chatForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        const query = userInput.value.trim();
        if (!query) return;

        // Add user message
        appendMessage('user', query);
        userInput.value = '';

        // Show typing
        showTyping();

        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const response = await fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ query: query })
            });

            const data = await response.json();

            removeTyping();

            if (data.success) {
                appendMessage('assistant', data.response);
            } else {
                appendMessage('assistant', `Error: ${data.message || 'Something went wrong.'}`);
            }
        } catch (error) {
            removeTyping();
            console.error('Error:', error);
            appendMessage('assistant', 'Sorry, I encountered a network error. Please try again.');
        }
    });
</script>
{% endblock %}
{% endblock %}